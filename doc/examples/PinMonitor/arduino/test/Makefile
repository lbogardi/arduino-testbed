# A sample Makefile for building Google Test and using it in user
# tests.  Please tweak it to suit your environment and project.  You
# may want to move it to your project's root directory.
#
# SYNOPSIS:
#
#   make [all]  - makes everything.
#   make TARGET - makes the given target.
#   make clean  - removes all files generated by make.

# Please tweak the following variable definitions as needed by your
# project, except GTEST_HEADERS, which you can use in your own targets
# but shouldn't modify.

TEST_DIR = .
TEST_LIB_DIR = .
SRC_DIR = ../lib
BUILD_DIR = ./build

TESTS = test_TaskScheduler

CPPFLAGS += -I/usr/include/gtest -I$(TEST_LIB_DIR) -L$(TEST_LIB_DIR)
CXXFLAGS += -g -Wall -Wextra

RUNNERS = $(addprefix run-,$(TESTS))

#
#	House-keeping and general targets
#

test : all run-all

all : directories $(TESTS)

directories : $(BUILD_DIR)

run-all : $(RUNNERS)

clean :
	rm -rf $(TESTS) build/

$(RUNNERS) : $(TESTS)
	./$<

$(BUILD_DIR) :
	mkdir -p $(BUILD_DIR)

$(BUILD_DIR)/%.o : $(TEST_LIB_DIR)/%.cpp $(GTEST_HEADERS)
	$(CXX) $(CPPFLAGS) $(CXXFLAGS) \
			-I $(SRC_DIR)/TaskScheduler \
			-c -o $@ $<

#
#	Google Test
#

GTEST_DIR = /usr/src/gtest
GTEST_HEADERS = /usr/include/gtest/*.h \
                /usr/include/gtest/internal/*.h

GTEST_SRCS_ = $(GTEST_DIR)/src/*.cc $(GTEST_DIR)/src/*.h $(GTEST_HEADERS)

$(BUILD_DIR)/gtest-all.o : $(GTEST_SRCS_)
	$(CXX) $(CPPFLAGS) -I$(GTEST_DIR) $(CXXFLAGS) \
			-c $(GTEST_DIR)/src/gtest-all.cc \
			-o $(BUILD_DIR)/gtest-all.o

$(BUILD_DIR)/gtest_main.o : $(GTEST_SRCS_)
	$(CXX) $(CPPFLAGS) -I$(GTEST_DIR) $(CXXFLAGS) \
			-c $(GTEST_DIR)/src/gtest_main.cc \
			-o $(BUILD_DIR)/gtest_main.o

$(BUILD_DIR)/gtest.a : $(BUILD_DIR)/gtest-all.o
	$(AR) $(ARFLAGS) $@ $^

$(BUILD_DIR)/gtest_main.a : $(BUILD_DIR)/gtest-all.o $(BUILD_DIR)/gtest_main.o
	$(AR) $(ARFLAGS) $@ $^

#
#	test_TaskScheduler
#

$(BUILD_DIR)/TaskScheduler.o : $(SRC_DIR)/TaskScheduler/TaskScheduler.cpp
	$(CXX) $(CPPFLAGS) $(CXXFLAGS) \
			-I $(SRC_DIR)/TaskScheduler \
			-c $(SRC_DIR)/TaskScheduler/TaskScheduler.cpp \
			-o $(BUILD_DIR)/TaskScheduler.o

test_TaskScheduler : $(BUILD_DIR)/TaskScheduler.o \
					 $(BUILD_DIR)/test_TaskScheduler.o \
					 $(BUILD_DIR)/Arduino.o \
					 $(BUILD_DIR)/ArduinoProxy.o \
					 $(BUILD_DIR)/FakeArduinoClock.o \
					 $(BUILD_DIR)/FakeArduino.o \
					 $(BUILD_DIR)/TriggerLogger.o \
					 $(BUILD_DIR)/gtest.a
	$(CXX) $(CPPFLAGS) $(CXXFLAGS) $^ -o $@ -lpthread

